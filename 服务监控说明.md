# 安琦购电商平台 - 服务监控和错误处理说明

## 问题修复总结

### 原问题

所有接口都返回 500 错误,服务无法启动。

### 根本原因

**Bean 定义冲突**: `UserIdInterceptor` 类在 common 模块和 order-service 模块中重复定义,导致 Spring 容器启动失败。

错误信息:

```
ConflictingBeanDefinitionException: Annotation-specified bean name 'userIdInterceptor'
for bean class [com.anqigou.common.interceptor.UserIdInterceptor] conflicts with existing,
non-compatible bean definition of same name and class [com.anqigou.order.config.UserIdInterceptor]
```

### 解决方案

1. **清理编译缓存**: 执行 `mvn clean` 删除所有旧的编译文件
2. **重新编译**: 执行 `mvn install -DskipTests` 重新编译所有模块
3. **重启服务**: 使用 `start-all-services.bat` 重新启动所有服务

### 当前服务状态

✅ 所有服务已成功启动:

- 用户服务 (8081) - 运行中
- 商品服务 (8082) - 运行中
- 订单服务 (8083) - 运行中
- 支付服务 (8084) - 运行中
- 物流服务 (8085) - 运行中
- 网关服务 (8080) - 运行中

---

## 日志查看和错误监控

### 方法一: 使用日志查看脚本 (推荐)

运行日志查看器:

```bash
cd anqigou-java-spring
view-logs.bat
```

功能说明:

1. **查看所有服务的最新日志** - 显示每个服务最后 30 行日志
2. **查看所有服务的错误日志** - 筛选显示包含 ERROR、EXCEPTION、FAILED、WARN 的日志
3. **实时监控所有服务错误** - 每 5 秒自动刷新,持续监控错误信息
4. **查看单个服务日志** - 选择特定服务查看完整日志
5. **检查服务状态** - 显示运行中的服务和端口占用情况

### 方法二: 手动查看日志文件

各服务日志文件位置:

```
anqigou-java-spring/
├── anqigou-user-service/logs.txt       # 用户服务日志
├── anqigou-product-service/logs.txt    # 商品服务日志
├── anqigou-order-service/logs.txt      # 订单服务日志
├── anqigou-payment-service/logs.txt    # 支付服务日志
├── anqigou-logistics-service/logs.txt  # 物流服务日志
└── anqigou-gateway/logs.txt            # 网关服务日志
```

查看特定服务错误:

```bash
# 查看订单服务的错误
findstr /i "error exception failed" anqigou-order-service\logs.txt

# 实时监控用户服务日志
powershell -Command "Get-Content anqigou-user-service\logs.txt -Wait -Tail 20"
```

### 方法三: 检查 JVM 崩溃日志

如果服务异常退出,检查 JVM 错误日志:

```bash
# 查看最新的JVM错误
dir /b /o-d hs_err_*.log
type hs_err_pid*.log
```

---

## 常见错误类型和处理

### 1. Bean 定义冲突

**错误特征**: `ConflictingBeanDefinitionException`
**解决方案**:

```bash
cd anqigou-java-spring
mvn clean
mvn install -DskipTests
```

### 2. 端口被占用

**错误特征**: `Address already in use: bind`
**检查占用**:

```bash
netstat -ano | findstr "808[0-5]"
```

**解决方案**: 关闭占用端口的进程或修改配置文件中的端口号

### 3. Nacos 连接失败

**错误特征**: `Connection refused` 或 `Unable to connect to Nacos`
**解决方案**:

1. 确认 Nacos 是否启动: 访问 http://localhost:8848/nacos
2. 检查配置文件中的 Nacos 地址是否正确

### 4. 数据库连接失败

**错误特征**: `Communications link failure` 或 `Access denied for user`
**解决方案**:

1. 确认 MySQL 服务是否启动
2. 检查 `application.yml` 中的数据库配置
3. 验证用户名和密码是否正确

### 5. Redis 连接失败

**错误特征**: `Unable to connect to Redis`
**解决方案**:

1. 确认 Redis 服务是否启动
2. 检查 `application.yml` 中的 Redis 配置

---

## 实时错误监控命令

### 监控所有服务错误 (推荐)

```bash
view-logs.bat
# 选择选项 3 - 实时监控
```

### 单独监控某个服务

```bash
# 监控订单服务
powershell -Command "while($true) { Clear-Host; Write-Host '[' (Get-Date) '] 订单服务错误日志'; Get-Content anqigou-order-service\logs.txt -Tail 20 | Select-String 'ERROR|WARN|Exception' -CaseSensitive:$false; Start-Sleep 3 }"
```

### 检查服务运行状态

```bash
# 查看Java进程
jps -l | findstr anqigou

# 查看端口占用
netstat -ano | findstr "808[0-5]" | findstr "LISTENING"
```

---

## 服务健康检查

### 通过网关访问

```bash
# 用户服务健康检查
curl http://localhost:8080/api/user/actuator/health

# 商品服务健康检查
curl http://localhost:8080/api/product/actuator/health

# 订单服务健康检查
curl http://localhost:8080/api/order/actuator/health
```

### 直接访问服务

```bash
# 用户服务
curl http://localhost:8081/actuator/health

# 商品服务
curl http://localhost:8082/actuator/health

# 订单服务
curl http://localhost:8083/actuator/health
```

---

## 故障排查流程

1. **检查服务是否运行**

   ```bash
   jps -l | findstr anqigou
   ```

2. **查看最新错误日志**

   ```bash
   view-logs.bat
   # 选择选项 2
   ```

3. **检查端口占用**

   ```bash
   netstat -ano | findstr "808[0-5]"
   ```

4. **查看具体服务日志**

   ```bash
   view-logs.bat
   # 选择选项 4,然后选择对应的服务
   ```

5. **重启问题服务**

   - 先停止服务(Ctrl+C 或关闭窗口)
   - 重新运行对应服务的启动命令

6. **如果所有服务都有问题,重启全部**

   ```bash
   # 停止所有服务
   taskkill /F /IM java.exe

   # 重新启动
   start-all-services.bat
   ```

---

## 日志级别说明

- **ERROR**: 严重错误,需要立即处理
- **WARN**: 警告信息,可能存在问题但不影响运行
- **INFO**: 一般信息,记录正常运行状态
- **DEBUG**: 调试信息,详细的运行过程

建议重点关注 **ERROR** 和 **WARN** 级别的日志。

---

## 获取帮助

如果遇到无法解决的问题:

1. 收集以下信息:
   - 错误日志内容
   - 服务运行状态 (`jps -l`)
   - 端口占用情况 (`netstat -ano | findstr "808[0-5]"`)
2. 检查是否有 JVM 崩溃日志:

   ```bash
   dir hs_err_*.log
   ```

3. 使用日志查看器导出完整日志进行分析

---

## 更新日志

- 2025-12-02: 修复 Bean 冲突问题,添加日志监控工具
- 创建日志查看脚本 `view-logs.bat`
- 编写服务监控说明文档
